name: Match Scraper

on:
  # run every 4 hours
  schedule:
    - cron: '0 */4 * * *'
  # allow manual trigger
  workflow_dispatch:
    inputs:
      duration_minutes:
        description: 'How long to run the scraper (minutes)'
        required: false
        default: '50'
        type: string

jobs:
  scrape:
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      - name: Run scraper via API
        run: |
          DURATION=${{ github.event.inputs.duration_minutes || '50' }}
          echo "Calling scraper API for ${DURATION} minutes..."
          
          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${{ secrets.CRON_SECRET }}" \
            -d "{\"duration_minutes\": ${DURATION}}" \
            "${{ secrets.NEXT_PUBLIC_SITE_URL }}/api/scraper" \
            --max-time 3600)
          
          HTTP_CODE=$(echo "$RESPONSE" | tail -n 1)
          BODY=$(echo "$RESPONSE" | sed '$d')
          
          echo "Response code: $HTTP_CODE"
          echo "Response body: $BODY"
          
          if [ "$HTTP_CODE" != "200" ]; then
            echo "Scraper API returned error"
            exit 1
          fi
          
          echo "$BODY" | jq '.'
