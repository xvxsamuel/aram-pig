name: Match Scraper

on:
  # run every 4 hours
  schedule:
    - cron: '0 */4 * * *'
  # allow manual trigger
  workflow_dispatch:
    inputs:
      duration_minutes:
        description: 'How long to run the scraper (minutes)'
        required: false
        default: '50'
        type: string

jobs:
  scrape:
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      - name: Run scraper via API
        run: |
          DURATION=${{ github.event.inputs.duration_minutes || '50' }}
          echo "========================================"
          echo "Starting scraper API call"
          echo "========================================"
          echo "URL: ${{ secrets.NEXT_PUBLIC_SITE_URL }}/api/scraper"
          echo "Duration: ${DURATION} minutes"
          echo "Time: $(date -u)"
          echo "========================================"
          
          # Make the API call with verbose output
          RESPONSE=$(curl -s -L -w "\n%{http_code}" -X POST \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${{ secrets.CRON_SECRET }}" \
            -d "{\"duration_minutes\": ${DURATION}}" \
            "${{ secrets.NEXT_PUBLIC_SITE_URL }}/api/scraper" \
            --max-time 3600)
          
          HTTP_CODE=$(echo "$RESPONSE" | tail -n 1)
          BODY=$(echo "$RESPONSE" | sed '$d')
          
          echo ""
          echo "========================================"
          echo "API Response"
          echo "========================================"
          echo "HTTP Status: $HTTP_CODE"
          echo "Response Body:"
          echo "$BODY" | jq '.' 2>/dev/null || echo "$BODY"
          echo "========================================"
          
          if [ "$HTTP_CODE" != "200" ]; then
            echo ""
            echo "❌ Scraper API returned error (HTTP $HTTP_CODE)"
            exit 1
          fi
          
          # Extract and display key metrics
          echo ""
          echo "========================================"
          echo "Scraper Results Summary"
          echo "========================================"
          MATCHES=$(echo "$BODY" | jq -r '.matches_stored // "N/A"')
          DURATION_SEC=$(echo "$BODY" | jq -r '.duration_seconds // "N/A"')
          echo "✅ Matches stored: $MATCHES"
          echo "⏱️  Duration: ${DURATION_SEC}s"
          echo ""
          echo "Results by region:"
          echo "$BODY" | jq -r '.results_by_region // {}' 2>/dev/null || echo "N/A"
          echo "========================================"
